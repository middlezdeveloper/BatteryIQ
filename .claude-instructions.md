# Claude Code Safety Protocol - BatteryIQ Project

## üîë CODEWORD: 'cook'

You MUST follow these rules for ALL destructive operations in this project.

---

## ‚ö†Ô∏è CRITICAL RULES

### BEFORE any of these operations, you MUST:

1. **Create backup**: `./scripts/backup-state.sh`
2. **Show user the changes**: Full diff, file list, or description
3. **Request codeword**: Display: `"Type 'cook' to proceed"`
4. **WAIT**: Do NOT proceed until user types exactly: `cook`

### Operations requiring codeword 'cook':

- ‚úã `git commit` (any commit)
- ‚úã `git reset` (especially --hard)
- ‚úã `git push --force`
- ‚úã `git checkout` (switching branches with uncommitted changes)
- ‚úã `git stash drop`
- ‚úã Database operations:
  - `prisma migrate reset`
  - `prisma db push --force-reset`
  - Any `PRISMA_USER_CONSENT_FOR_DANGEROUS_AI_ACTION`
- ‚úã File deletions (`rm`, `rm -rf`)
- ‚úã Overwriting existing files without reading first
- ‚úã Deploying to production

---

## üìã Required Workflow Example

### For Commits:

```
1. I create a backup:
   $ ./scripts/backup-state.sh
   ‚úÖ Backup created: 2025-10-04-07-35-22

2. I show you what will be committed:
   Changes to be committed:
     M src/app/page.tsx (23 lines changed)
     A src/lib/new-feature.ts (new file, 145 lines)
     M package.json (1 dependency added)

   Full diff:
   [show complete git diff output]

3. I request confirmation:
   Type 'cook' to proceed with this commit.

4. I WAIT for you to type: cook

5. Only after receiving 'cook', I execute:
   $ git add .
   $ git commit -m "Add new feature"
```

### For Rollbacks:

```
1. I create a backup:
   $ ./scripts/backup-state.sh
   ‚úÖ Backup created: 2025-10-04-07-35-22

2. I show you what will be lost:
   Current commit: abc1234 "Latest work"
   Rolling back to: def5678 "Previous state"

   Changes that will be lost:
   [show git diff between commits]

   Uncommitted changes that will be lost:
   [show git status and diff]

3. I request confirmation:
   ‚ö†Ô∏è  WARNING: This will lose the above changes.
   Type 'cook' to proceed with rollback.

4. I WAIT for you to type: cook

5. Only after receiving 'cook', I execute:
   $ git reset --hard def5678
```

### For Database Resets:

```
1. I create a backup:
   $ ./scripts/backup-state.sh
   ‚úÖ Backup created: 2025-10-04-07-35-22

2. I show you current state:
   Current database contains:
   - 3 users
   - 15 energyPlans
   - 2 batteries
   [etc.]

3. I explain what will happen:
   ‚ö†Ô∏è  This will DELETE ALL DATA and reset to schema only.

4. I request confirmation:
   Type 'cook' to proceed with database reset.

5. I WAIT for you to type: cook

6. Only after receiving 'cook', I execute:
   $ PRISMA_USER_CONSENT_FOR_DANGEROUS_AI_ACTION="go" npx prisma migrate reset --force
```

---

## üö´ ABSOLUTELY NEVER WITHOUT 'cook':

These commands are FORBIDDEN without the codeword:

```bash
# ‚ùå NEVER run these without codeword
git reset --hard
git push --force
git push --no-verify
git stash drop
git branch -D
rm -rf
PRISMA_USER_CONSENT_FOR_DANGEROUS_AI_ACTION="go"
```

---

## ‚úÖ Safe Operations (No codeword needed):

These are OK to run without asking:

```bash
# ‚úÖ Read-only operations
git status
git diff
git log
git show
ls
cat
grep
find

# ‚úÖ Non-destructive operations
git add
git stash
git branch
npm install
npm run build
npm run dev

# ‚úÖ Backup operations
./scripts/backup-state.sh
./scripts/list-backups.sh
```

---

## üÜò If You Make a Mistake

If you accidentally performed a destructive operation without the codeword:

1. **Immediately tell the user**: "‚ö†Ô∏è  I made an error and [operation] without asking for 'cook'. I apologize."
2. **Stop all operations**: Do not continue with any plan
3. **Show restoration options**:
   ```
   You can restore from the most recent backup:
   $ ./scripts/list-backups.sh
   $ ./scripts/restore-backup.sh <timestamp>
   ```
4. **Learn**: This should never happen. The codeword system exists to prevent this.

---

## üìù Project-Specific Notes

### BatteryIQ Database

- Development DB: `prisma/dev.db` (SQLite)
- Production DB: PostgreSQL on Vercel
- **NEVER** reset production database without explicit approval

### Critical Files

Extra care needed for:
- `prisma/schema.prisma` - Database schema
- `.env` - Contains API keys
- `src/generated/prisma/` - Auto-generated, but critical

### Deployment

- Main branch ‚Üí Auto-deploys to production (Vercel)
- **ALWAYS** test builds locally first: `npm run build`
- **ALWAYS** get 'cook' before pushing to main

---

## üéØ Your Commitment

By following this protocol, you commit to:

1. ‚úÖ **NEVER** commit without showing changes and getting 'cook'
2. ‚úÖ **NEVER** rollback without showing what will be lost and getting 'cook'
3. ‚úÖ **NEVER** reset database without backing up and getting 'cook'
4. ‚úÖ **ALWAYS** create backups before destructive operations
5. ‚úÖ **ALWAYS** show complete diffs and changes before requesting 'cook'
6. ‚úÖ **ALWAYS** wait for the exact word 'cook' - no synonyms, no assumptions

---

## üìö Quick Reference

### Test the safety system:

```bash
# Create a backup
./scripts/backup-state.sh

# List backups
./scripts/list-backups.sh

# Restore (for testing)
./scripts/restore-backup.sh <timestamp>
```

### Check if hooks are installed:

```bash
ls -la .git/hooks/pre-commit
ls -la .git/hooks/pre-push
```

---

**Remember**: The codeword 'cook' is your user's safety mechanism. Respect it absolutely. When in doubt, ask for 'cook'. Better to ask unnecessarily than to cause data loss.

**Last Updated**: 2025-10-04
**System Version**: 1.0
